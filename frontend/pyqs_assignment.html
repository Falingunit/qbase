<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      http-equiv="Cache-Control"
      content="no-store, no-cache, must-revalidate, max-age=0"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>QBase - PYQs</title>
    <!-- Resource hints -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css"
    />
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Serif:ital,wght@0,100..900;1,100..900&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr"
      crossorigin="anonymous"
    />

    <link href="./common/theme.css" rel="stylesheet" />
    <!-- EasyMDE CSS before our local overrides so our assignment.css can win -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css"
    />
    <link href="./assignment/assignment.css" rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js"
    ></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/mhchem.min.js"
    ></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js"
    ></script>
    <script defer src="./common/config.js"></script>
    <style>
      /* Invert question/option/passage/solution images for dark theme readability */
      #questionText img,
      #MCQOptionDiv .opt-text img,
      #passageText img,
      #solutionText img,
      #questionImage img,
      #solutionImage img {
        filter: invert(1) hue-rotate(180deg) contrast(1.05);
      }
    </style>
    <!-- Modal helpers (same API as navbar.js) -->
    <script>
      (function () {
        function ensureModalHost() {
          if (document.getElementById("qbaseModal")) return;
          const tpl = document.createElement("div");
          tpl.innerHTML = `
            <div class="modal fade" id="qbaseModal" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header border-0">
                    <h5 class="modal-title" id="qbaseModalTitle">Message</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body" id="qbaseModalBody"></div>
                  <div class="modal-footer border-0" id="qbaseModalFooter"></div>
                </div>
              </div>
            </div>`;
          document.body.appendChild(tpl.firstElementChild);
        }

        let __modalChain = Promise.resolve();
        function queueModal(taskFn) {
          __modalChain = __modalChain.then(() => taskFn()).catch(() => {});
          return __modalChain;
        }

        function showModal({
          title,
          bodyHTML,
          buttons,
          focusSelector,
          backdrop = "static",
          keyboard = true,
          onContentReady,
        }) {
          return queueModal(
            () =>
              new Promise((resolve) => {
                ensureModalHost();
                const modalEl = document.getElementById("qbaseModal");
                const titleEl = document.getElementById("qbaseModalTitle");
                const bodyEl = document.getElementById("qbaseModalBody");
                const footEl = document.getElementById("qbaseModalFooter");

                titleEl.textContent = title || "Message";
                bodyEl.innerHTML = bodyHTML || "";
                footEl.innerHTML = "";

                // Allow caller to attach event listeners to freshly inserted content
                try {
                  if (typeof onContentReady === "function")
                    onContentReady(modalEl);
                } catch {}

                let result;
                const onHidden = () => {
                  modalEl.removeEventListener("hidden.bs.modal", onHidden);
                  resolve(result);
                };
                modalEl.addEventListener("hidden.bs.modal", onHidden, {
                  once: true,
                });

                (buttons || []).forEach((b, i) => {
                  const btn = document.createElement("button");
                  btn.type = "button";
                  btn.className = b.className || "btn btn-primary";
                  btn.textContent = b.text || `Button ${i + 1}`;
                  btn.addEventListener("click", () => {
                    result = b.value;
                    bsModal.hide();
                  });
                  footEl.appendChild(btn);
                });

                const bsModal = new bootstrap.Modal(modalEl, {
                  backdrop,
                  keyboard,
                });
                if (focusSelector) {
                  modalEl.addEventListener(
                    "shown.bs.modal",
                    () => {
                      const el = modalEl.querySelector(focusSelector);
                      if (el) el.focus();
                    },
                    { once: true }
                  );
                }
                bsModal.show();
              })
          );
        }

        async function showConfirm({
          title,
          message,
          okText = "OK",
          cancelText = "Cancel",
        }) {
          return await showModal({
            title,
            bodyHTML: `<p class="mb-0">${message}</p>`,
            buttons: [
              {
                text: cancelText,
                className: "btn btn-outline-secondary",
                value: false,
              },
              { text: okText, className: "btn btn-success", value: true },
            ],
          });
        }

        async function showPrompt({
          title,
          // Accept either `label` or legacy `message`
          label,
          message,
          placeholder = "",
          okText = "OK",
          cancelText = "Cancel",
          // Accept either `initial` or legacy `defaultValue`
          initial,
          defaultValue,
        }) {
          const id = "qbasePromptInput";
          const body = `
            <label for="${id}" class="form-label">${
            (label ?? message) || "Enter value"
          }</label>
            <input id="${id}" class="form-control" type="text" placeholder="${placeholder}" value="${
            initial ?? defaultValue ?? ""
          }">
          `;
          const res = await showModal({
            title,
            bodyHTML: body,
            buttons: [
              {
                text: cancelText,
                className: "btn btn-outline-secondary",
                value: null,
              },
              { text: okText, className: "btn btn-primary", value: "__OK__" },
            ],
            focusSelector: `#${id}`,
          });
          const input = document.getElementById(id);
          if (res === "__OK__") return (input?.value || "").trim();
          return null;
        }

        async function showNotice({ title, message, okText = "OK" }) {
          await showModal({
            title,
            bodyHTML: `<p class="mb-0">${message}</p>`,
            buttons: [
              { text: okText, className: "btn btn-primary", value: true },
            ],
          });
        }

        // Expose globally for assignment.js
        window.showModal = showModal;
        window.showConfirm = showConfirm;
        window.showPrompt = showPrompt;
        window.showNotice = showNotice;
      })();
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
      crossorigin="anonymous"
    ></script>
  </head>
  <body class="bg-dark text-light" style="max-height: 10vh !important">
    <!-- navbar removed for assignment page -->
    <div
      class="assignment-topbar py-2 px-3 d-flex justify-content-between align-items-center"
    >
      <div class="d-flex align-items-center gap-2">
        <a
          href="./index.html"
          class="topbar-back"
          title="Back to Home"
          aria-label="Back to Home"
        >
          <i class="bi bi-arrow-left" aria-hidden="true"></i>
          <span class="visually-hidden">Back</span>
        </a>
        <h5 class="mb-0" id="assignment-title">Assignment</h5>
      </div>
      <div class="topbar-actions">
        <div class="topbar-group" aria-label="View controls">
          <!-- Toggle desktop sidebar Questions list (default on for desktop) -->
          <button
            id="toggle-questions"
            class="btn btn-outline-secondary btn-sm"
            title="Show/Hide Questions sidebar"
          >
            <i class="bi bi-layout-sidebar-inset-reverse"></i>
            <span class="d-none d-sm-inline">Side Bar</span>
          </button>
          <!-- Toggle showing the mobile Q-bar on desktop (always on in mobile) -->
          <button
            id="toggle-qbar"
            class="btn btn-outline-secondary btn-sm d-none d-lg-inline-flex"
            title="Show the compact Q-bar on desktop"
          >
            <i class="bi bi-chevron-bar-up"></i>
            <span class="d-none d-sm-inline">Top Bar</span>
          </button>
          <span class="topbar-sep">|</span>

          <!-- Font size slider: adjusts only question + options -->
          <div
            class="qa-font-control d-flex align-items-center"
            title="Adjust question font size"
          >
            <i class="bi bi-fonts me-2" aria-hidden="true"></i>
            <input
              id="qa-font-range"
              class="form-range qa-font-range"
              type="range"
              min="90"
              max="140"
              step="5"
              value="100"
              aria-label="Question font size"
            />
          </div>
        </div>

        <span class="topbar-sep">|</span>

        <div class="topbar-group" aria-label="Reset controls">
          <button
            id="reset-assignment"
            class="btn btn-outline-danger btn-sm align-self-end"
            title="Reset entire assignment"
          >
            <i class="bi bi-arrow-counterclockwise" aria-hidden="true"></i>
            <span class="d-none d-sm-inline">Reset Assignment</span>
          </button>
        </div>
      </div>
    </div>

    <div
      class="container-fluid px-0 main-wrapper d-flex justify-content-between"
    >
      <div class="overflow-y-scroll" style="width: 100%">
        <div class="p-4">
          <!-- Initial load skeleton overlay (fades while questions fetch) -->
          <div id="q-skeleton" class="q-skeleton-overlay" aria-hidden="true">
            <div class="sk-card">
              <div class="sk-header">
                <div class="sk-line sk-w-20"></div>
                <div>
                  <span class="sk-pill sk-w-12"></span>
                  <span class="sk-pill sk-w-10"></span>
                </div>
              </div>
              <div class="sk-body">
                <div class="sk-line sk-w-90"></div>
                <div class="sk-line sk-w-80"></div>
                <div class="sk-line sk-w-60"></div>
              </div>
            </div>
            <div class="sk-options">
              <div class="sk-option"></div>
              <div class="sk-option"></div>
              <div class="sk-option"></div>
              <div class="sk-option"></div>
            </div>
          </div>
          <div id="mobile-qbar"></div>

          <div class="card mb-4 flex-shrink-0">
            <div
              class="card-header d-flex justify-content-between align-items-center"
            >
              <div>
                <strong style="font-weight: 600">
                  Q-<span id="qNo">1</span>
                </strong>
                <span
                  class="text-muted small ms-2"
                  id="origNoWrap"
                  title="Original ID in server"
                >
                  (ID <span id="origNo">1</span>)
                </span>
                <div class="small text-muted" id="assignmentDetails"></div>
              </div>
              <div class="d-flex align-items-center gap-2">
                <button
                  id="bookmark-btn"
                  class="btn btn-sm btn-outline-primary"
                  title="Bookmark this question"
                >
                  <i class="bi bi-bookmark"></i>
                </button>
                <!-- Quick color marks -->
                <div
                  id="qcolor-picker"
                  class="qcolor-picker collapsed"
                  title="Mark question"
                >
                  <button
                    type="button"
                    class="qcolor-chip"
                    data-color="none"
                    aria-label="No color (clear)"
                  ></button>
                  <button
                    type="button"
                    class="qcolor-chip"
                    data-color="#0d6efd"
                    style="--qc: #0d6efd"
                    aria-label="Mark blue"
                  ></button>
                  <button
                    type="button"
                    class="qcolor-chip"
                    data-color="#dc3545"
                    style="--qc: #dc3545"
                    aria-label="Mark red"
                  ></button>
                  <button
                    type="button"
                    class="qcolor-chip"
                    data-color="#ffc107"
                    style="--qc: #ffc107"
                    aria-label="Mark yellow"
                  ></button>
                  <button
                    type="button"
                    class="qcolor-chip"
                    data-color="#198754"
                    style="--qc: #198754"
                    aria-label="Mark green"
                  ></button>
                </div>
                <span id="timer" class="badge bg-dark text-info">00:11</span>
                <span
                  class="badge bg-dark-subtle text-info"
                  id="qTypeInfo"
                ></span>
              </div>
            </div>
            <div class="card-body">
              <div class="d-flex flex-column flex-md-row passage-wrapper">
                <div
                  id="passageText"
                  class="fonted card-text passage-text mb-3"
                  style="display: none; width: 70%"
                ></div>
                <div
                  id="passageImage"
                  class="passage-image mb-3"
                  style="display: none; width: 30%"
                ></div>
              </div>
              <p id="questionText" class="fonted"></p>
              <div
                id="questionImage"
                class="question-image mb-3"
                style="display: none"
              ></div>
              <div id="pyq-info" class="small text-muted"></div>
            </div>
          </div>

          <div class="mb-3 fonted" id="MCQOptionDiv">
            <button
              class="btn btn-outline-secondary text-body mcq-option text-start w-100 mb-2"
              data-opt="A"
            >
              <span class="opt-badge" aria-hidden="true">A</span>
              <span class="opt-text"><span id="AContent"></span></span>
            </button>
            <button
              class="btn btn-outline-secondary text-body mcq-option text-start w-100 mb-2"
              data-opt="B"
            >
              <span class="opt-badge" aria-hidden="true">B</span>
              <span class="opt-text"><span id="BContent"></span></span>
            </button>
            <button
              class="btn btn-outline-secondary text-body mcq-option text-start w-100 mb-2"
              data-opt="C"
            >
              <span class="opt-badge" aria-hidden="true">C</span>
              <span class="opt-text"><span id="CContent"></span></span>
            </button>
            <button
              class="btn btn-outline-secondary text-body mcq-option text-start w-100 mb-2"
              data-opt="D"
            >
              <span class="opt-badge" aria-hidden="true">D</span>
              <span class="opt-text"><span id="DContent"></span></span>
            </button>
          </div>

          <div class="options-list flex-grow-1 mb-3" id="numericalDiv">
            <input
              id="numericalInput"
              class="form-control"
              type="number"
              placeholder="Enter your answer..."
              aria-label="Numerical Answer"
            />
            <div class="text-body-emphasis" style="display: none">
              <strong>Correct Answer:</strong>
              <span id="numericalAnswer"></span>
            </div>
          </div>

          <!-- Solution (hidden until answer is checked) -->
          <div id="solutionSection" class="mb-3" style="display: none">
            <h5 class="h6 text-info mb-2">Solution</h5>
            <div id="solutionText" class="fonted"></div>
            <div
              id="solutionImage"
              class="question-image mt-2"
              style="display: none"
            ></div>
          </div>

          <hr />

          <!-- Notes Section (visible for all question types) -->
          <div class="mb-3" id="notesSection">
            <label class="form-label h5" for="notesInput">Notes:</label>
            <!-- CodeMirror host: we keep the same id so existing code can locate it -->
            <textarea
              id="notesInput"
              class="form-control p-0 notes-editor-host"
              placeholder="Add your notes..."
              style="min-height: 180px"
              aria-label="Notes editor"
            ></textarea>
          </div>
        </div>
        <div id="question-actions" class="question-actions">
          <div class="controls d-flex flex-shrink-0">
            <button
              id="nav-prev"
              class="btn btn-outline-light question-nav-btn"
              title="Previous question"
            >
              <i class="bi bi-chevron-left me-1" aria-hidden="true"></i>
              Previous
            </button>
            <button
              id="nav-next"
              class="btn btn-outline-light question-nav-btn"
              title="Next question"
            >
              Next
              <i class="bi bi-chevron-right ms-1" aria-hidden="true"></i>
            </button>
            <button id="check-answer" class="btn btn-success">
              Check Answer
            </button>
            <button
              id="reset-question"
              class="btn btn-outline-light d-none"
              title="Reset this question"
            >
              Reset Question
            </button>
          </div>
        </div>
      </div>

      <div
        class="right-col p-3 d-none d-lg-block overflow-y-scroll"
        style="border: none"
      >
        <div class="d-flex align-items-center justify-content-between mb-3">
          <h6 class="mb-0">Questions</h6>
          <button
            id="filters-info-btn"
            class="btn btn-sm btn-outline-secondary"
            title="Show active filters"
          >
            <i class="bi bi-info-circle"></i>
          </button>
        </div>
        <div
          class="controls justify-content-between flex-shrink-0"
          style="padding-top: 1rem"
        >
          <div class="row row-cols-4 g-3" id="q_list"></div>
        </div>
      </div>
      <!-- Optional: DOMPurify for safe HTML rendering in PYQs -->
      <script
        defer
        src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"
      ></script>
      <!-- PYQs: provide custom data loader and use PYQ-aware viewer -->
      <script>
        // Provide a custom loader so the viewer can render PYQ chapter data
        (function () {
          window.__ASSIGNMENT_CUSTOM_LOADER__ = async function () {
            try {
              if (typeof loadConfig === "function") await loadConfig();
            } catch {}
            const fetcher = typeof authFetch === "function" ? authFetch : fetch;
            const url = new URL(window.location.href);
            const exam = url.searchParams.get("exam");
            const subject = url.searchParams.get("subject");
            const chapter = url.searchParams.get("chapter");

            // Update back link to return to questions list for this chapter
            try {
              const back = document.querySelector("a.topbar-back");
              if (back && exam && subject) {
                const u = new URL(
                  "./pyqs_questions.html",
                  window.location.href
                );
                u.searchParams.set("exam", exam);
                u.searchParams.set("subject", subject);
                if (chapter) u.searchParams.set("chapter", chapter);
                back.href = u.toString();
                back.title = "Back to Questions";
                back.setAttribute("aria-label", "Back to Questions");
              }
            } catch {}

            // Derive a stable synthetic assignment ID from route params (for local save state)
            try {
              const key =
                String(exam || "") +
                "::" +
                String(subject || "") +
                "::" +
                String(chapter || "");
              let h = 0;
              for (let i = 0; i < key.length; i++)
                h = ((h << 5) - h + key.charCodeAt(i)) | 0; // djb2-ish
              const aID = (h >>> 0) % 2147483647;
              window.__PYQS_ASSIGNMENT_ID__ = aID;
            } catch {}

            // Resolve names (exam, subject, chapter) for metadata and title
            try {
              let examName = "",
                subjectName = "",
                chapterName = "";
              if (exam) {
                try {
                  const re = await fetcher(`${API_BASE}/api/pyqs/exams`, {
                    cache: "no-store",
                  });
                  if (re.ok) {
                    const ex = await re.json();
                    examName =
                      (ex || []).find((e) => String(e.id) === String(exam))
                        ?.name || "";
                  }
                } catch {}
              }
              if (exam && subject) {
                try {
                  const rs = await fetcher(
                    `${API_BASE}/api/pyqs/exams/${encodeURIComponent(
                      exam
                    )}/subjects`,
                    { cache: "no-store" }
                  );
                  if (rs.ok) {
                    const ss = await rs.json();
                    subjectName =
                      (ss || []).find((s) => String(s.id) === String(subject))
                        ?.name || "";
                  }
                } catch {}
              }
              if (exam && subject) {
                const rc = await fetcher(
                  `${API_BASE}/api/pyqs/exams/${encodeURIComponent(
                    exam
                  )}/subjects/${encodeURIComponent(subject)}/chapters`,
                  { cache: "no-store" }
                );
                if (rc.ok) {
                  const arr = await rc.json();
                  const ch = (arr || []).find(
                    (x) => String(x.id) === String(chapter)
                  );
                  if (ch && ch.name) chapterName = ch.name;
                }
              }
              if (chapterName) {
                window.__PYQS_ASSIGNMENT_TITLE__ = `PYQs - ${chapterName}`;
                try {
                  document.title = `QBase - ${window.__PYQS_ASSIGNMENT_TITLE__}`;
                } catch {}
                try {
                  const t = document.getElementById("assignment-title");
                  if (t) t.textContent = window.__PYQS_ASSIGNMENT_TITLE__;
                } catch {}
              }
              window.__PYQS_IDS__ = {
                examId: exam,
                subjectId: subject,
                chapterId: chapter,
              };
              window.__PYQS_META__ = {
                examId: exam,
                subjectId: subject,
                chapterId: chapter,
                examName,
                subjectName,
                chapterName,
              };
            } catch {}

            // Fetch questions for the selected chapter
            const resp = await fetcher(
              `${API_BASE}/api/pyqs/exams/${encodeURIComponent(
                exam
              )}/subjects/${encodeURIComponent(
                subject
              )}/chapters/${encodeURIComponent(chapter)}/questions`,
              { cache: "no-store" }
            );
            if (!resp.ok)
              throw new Error(`questions fetch failed: ${resp.status}`);
            const list = await resp.json();

            // Map server PYQ shape to assignment viewer shape AND track original indices
            let allQuestions = (Array.isArray(list) ? list : []).map(
              (q, originalIndex) => {
                const t = String(q?.type || "").toLowerCase();
                let qType = "SMCQ";
                if (
                  t.includes("numerical") ||
                  t === "numerical" ||
                  t.includes("integer")
                )
                  qType = "Numerical";
                else if (
                  Array.isArray(q?.correctAnswer) &&
                  q.correctAnswer.length > 1
                )
                  qType = "MMCQ";

                const qText = String(q?.qText || "");
                const image = q?.qImage || null;

                let qOptions = [];
                if (Array.isArray(q?.options) && q.options.length) {
                  qOptions = q.options
                    .map((o) => String(o?.oText || ""))
                    .slice(0, 4);
                  while (qOptions.length < 4) qOptions.push("");
                }

                let qAnswer;
                if (qType === "Numerical") {
                  const n = Number(q?.correctAnswer);
                  qAnswer = Number.isFinite(n) ? n : undefined;
                } else if (Array.isArray(q?.correctAnswer)) {
                  if (qType === "MMCQ")
                    qAnswer = q.correctAnswer.map((x) =>
                      String(x).trim().toUpperCase()
                    );
                  else
                    qAnswer = String(q.correctAnswer[0] || "")
                      .trim()
                      .toUpperCase();
                } else {
                  qAnswer = String(q?.correctAnswer || "")
                    .trim()
                    .toUpperCase();
                }

                return {
                  qType,
                  passageId: null,
                  qText,
                  image: image || null,
                  qOptions,
                  qAnswer,
                  pyqInfo: String(q?.pyqInfo || ""),
                  solutionText: String(q?.solution?.sText || ""),
                  solutionImage: q?.solution?.sImage || null,
                  diffuculty: String(q?.diffuculty || q?.level || ""),
                  __originalIndex: originalIndex, // ✓ Store original index
                };
              }
            );

            // Store the original total count BEFORE filtering
            const originalTotalCount = allQuestions.length;

            // Apply filters from server preferences (from list view)
            let filteredWithIndices = allQuestions.map((Q, originalIdx) => ({
              Q,
              originalIdx, // ✓ Track original index through filtering
            }));

            try {
              const prefUrl = `${API_BASE}/api/pyqs/prefs/${encodeURIComponent(
                exam
              )}/${encodeURIComponent(subject)}/${encodeURIComponent(chapter)}`;
              const prefResp = await authFetch(prefUrl);
              if (prefResp.ok) {
                const raw = await prefResp.json();

                // Unwrap if server returns {prefs: {...}}
                const serverPrefs =
                  raw &&
                  typeof raw === "object" &&
                  raw.prefs &&
                  typeof raw.prefs === "object"
                    ? raw.prefs
                    : raw;

                // Merge with safe defaults so .sort is always defined
                const defaults = {
                  q: "",
                  years: [],
                  status: "",
                  diff: "",
                  hasSol: false,
                  sort: "index",
                };
                const f = Object.assign({}, defaults, serverPrefs);

                window.__ASSIGNMENT_FILTER_OBJECT__ = f;

                function normDiff(d) {
                  const s = String(d || "").toLowerCase();
                  if (s.startsWith("1") || s.startsWith("e")) return "easy";
                  if (s.startsWith("2") || s.startsWith("m")) return "medium";
                  if (s.startsWith("3") || s.startsWith("h")) return "hard";
                  return "";
                }
                const parseYear = (info) => {
                  const m = String(info || "").match(/(19|20)\d{2}/);
                  return m ? Number(m[0]) : null;
                };
                const hasSol = (q) =>
                  String(q.solutionText || "").trim().length ||
                  String(q.solutionImage || "").trim().length;

                // Apply text/year/difficulty/solution filters
                filteredWithIndices = filteredWithIndices.filter(({ Q }) => {
                  if (
                    f.q &&
                    !String(Q.qText || "")
                      .toLowerCase()
                      .includes(String(f.q || "").toLowerCase())
                  )
                    return false;
                  if (Array.isArray(f.years) && f.years.length) {
                    const y = parseYear(Q.pyqInfo);
                    if (!y || !f.years.includes(y)) return false;
                  }
                  if (f.diff && normDiff(Q.diffuculty) !== f.diff) return false;
                  if (f.hasSol && !hasSol(Q)) return false;
                  return true;
                });

                // Apply status filter (requires server state lookup)
                if (f.status) {
                  try {
                    const stateResp = await authFetch(
                      `${API_BASE}/api/pyqs/state/${encodeURIComponent(
                        exam
                      )}/${encodeURIComponent(subject)}/${encodeURIComponent(
                        chapter
                      )}`
                    );
                    if (stateResp.ok) {
                      const states = await stateResp.json();
                      const statusFromState = (st) => {
                        if (!st) return "not-started";
                        if (st.isAnswerEvaluated)
                          return st.evalStatus || "completed";
                        if (st.isAnswerPicked) return "in-progress";
                        return "not-started";
                      };

                      // ✓ CRITICAL FIX: Use originalIdx, not display index
                      filteredWithIndices = filteredWithIndices.filter(
                        ({ originalIdx }) => {
                          const s = states?.[originalIdx]; // ✓ Access state by original index
                          const st = statusFromState(s);
                          if (f.status === "completed")
                            return !!s?.isAnswerEvaluated;
                          return st === f.status;
                        }
                      );
                    }
                  } catch (e) {
                    console.warn("Status filter failed:", e);
                  }
                }

                // Build human-readable summary
                const parts = [];
                if (f.q) parts.push(`Search: "${f.q}"`);
                if (f.years?.length) parts.push(`Years: ${f.years.join(", ")}`);
                if (f.diff) parts.push(`Difficulty: ${f.diff}`);
                if (f.status) parts.push(`Attempt: ${f.status}`);
                if (f.hasSol) parts.push("Has solution");
                window.__ASSIGNMENT_FILTER_INFO__ = parts.length
                  ? parts.join(" • ")
                  : "No filters";
                if (f.sort && f.sort !== "index") {
                  window.__ASSIGNMENT_FILTER_INFO__ += ` • Sort: ${f.sort}`;
                }
              }
            } catch (e) {
              console.warn("Filter application failed:", e);
            }

            // --- Apply sort according to saved prefs (year/difficulty/index) ---
            try {
              const f = window.__ASSIGNMENT_FILTER_OBJECT__ || {};
              const sort = String(f.sort || "index").toLowerCase();

              // Fallback if parseYear wasn't available (e.g., prefs fetch failed)
              const parseYearSafe = (info) => {
                try {
                  if (typeof parseYear === "function") return parseYear(info);
                } catch {}
                const m = String(info || "").match(/(19|20)\d{2}/);
                return m ? Number(m[0]) : null;
              };

              // Map difficulty to a rank for sorting
              const diffRank = (d) => {
                const s = String(d || "")
                  .trim()
                  .toLowerCase();

                // direct matches
                if (s === "easy" || s === "e" || s === "1") return 1;
                if (s === "medium" || s === "med" || s === "m" || s === "2")
                  return 2;
                if (s === "hard" || s === "h" || s === "3") return 3;

                // partials / variants
                if (/^e(as(y)?)?$/.test(s)) return 1;
                if (/^m(e(d(iu)?m)?)?$/.test(s)) return 2;
                if (/^h(ar(d)?)?$/.test(s)) return 3;

                // phrases like "level 1", "lvl 2"
                if (/^(level|lvl)\s*1$/.test(s)) return 1;
                if (/^(level|lvl)\s*2$/.test(s)) return 2;
                if (/^(level|lvl)\s*3$/.test(s)) return 3;

                // fallback: prefix-based (your old behavior)
                if (s.startsWith("e")) return 1;
                if (s.startsWith("m")) return 2;
                if (s.startsWith("h")) return 3;

                // unknown
                return null;
              };

              // Stable sort wrapper so ties keep original order
              const withPos = filteredWithIndices.map((row) => ({
                row,
                orig: row.originalIdx, // for stable tiebreak
              }));

              const cmp = (a, b) => {
                const A = a.row.Q;
                const B = b.row.Q;

                switch (sort) {
                  case "year-asc": {
                    const ay = parseYearSafe(A.pyqInfo) ?? -Infinity;
                    const by = parseYearSafe(B.pyqInfo) ?? -Infinity;
                    if (ay !== by) return ay - by;
                    break;
                  }
                  case "year-desc": {
                    const ay = parseYearSafe(A.pyqInfo) ?? -Infinity;
                    const by = parseYearSafe(B.pyqInfo) ?? -Infinity;
                    if (ay !== by) return by - ay;
                    break;
                  }
                  case "diff-asc": {
                    const ad = diffRank(A.diffuculty);
                    const bd = diffRank(B.diffuculty);

                    // Put unknowns LAST
                    if (ad == null && bd == null) break; // tie → tiebreaker
                    if (ad == null) return 1; // A unknown → after B
                    if (bd == null) return -1; // B unknown → after A

                    if (ad !== bd) return ad - bd; // easy→medium→hard
                    break;
                  }

                  case "diff-desc": {
                    const ad = diffRank(A.diffuculty);
                    const bd = diffRank(B.diffuculty);

                    // Put unknowns LAST
                    if (ad == null && bd == null) break; // tie → tiebreaker
                    if (ad == null) return 1; // A unknown → after B
                    if (bd == null) return -1; // B unknown → after A

                    if (ad !== bd) return bd - ad; // hard→medium→easy
                    break;
                  }
                  case "index":
                  default:
                    // keep API/list order
                    break;
                }
                // Stable tiebreak: original source order
                return a.orig - b.orig;
              };

              withPos.sort(cmp);
              filteredWithIndices = withPos.map((x) => x.row);
            } catch (e) {
              console.warn("Sort application failed:", e);
            }
            // --- END sort ---

            // Extract filtered questions and build index map
            const questions = filteredWithIndices.map((x) => x.Q);
            const originalIndexMap = filteredWithIndices.map(
              (x) => x.originalIdx
            );

            return {
              questions,
              originalIndexMap,
              originalTotalCount,
              allQuestionsMap: allQuestions,
            };
          };
        })();
      </script>
      <script defer src="./pyqs/pyqs-questions.js"></script>
      <!-- EasyMDE JS (after assignment.js so fallback textarea exists) -->
      <script
        defer
        src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"
      ></script>

      <!-- Check answer bar alignment -->
      <script>
        (function () {
          // === CONFIG: tweak selectors if you change layout ===
          const col = document.querySelector(
            ".main-wrapper > .overflow-y-scroll"
          );
          const bar = document.getElementById("question-actions");
          if (!col || !bar) return;

          // --- helpers ---
          const isVisible = (el) => {
            const s = getComputedStyle(el);
            return (
              s.display !== "none" &&
              s.visibility !== "hidden" &&
              el.getClientRects().length > 0
            );
          };

          let rafId = 0;
          const schedule = (fn) => {
            if (rafId) cancelAnimationFrame(rafId);
            rafId = requestAnimationFrame(() => {
              rafId = 0;
              fn();
            });
          };

          function alignAndReserve() {
            // 1) Make sure the bar is fixed to the viewport bottom
            bar.style.position = "fixed";
            bar.style.bottom = "0";
            bar.style.right = "auto";
            bar.style.zIndex = "1000";

            // 2) Align bar to the column's left edge & width
            const r = col.getBoundingClientRect();
            bar.style.left = r.left + "px";
            bar.style.width = r.width + "px";

            // 3) Reserve space inside the scrollable column
            col.style.paddingBottom = isVisible(bar)
              ? bar.offsetHeight + "px"
              : "0";
          }

          // Initial
          alignAndReserve();

          // React to size/layout changes (column resize, bar resize, responsive shifts)
          const ro = new ResizeObserver(() => schedule(alignAndReserve));
          ro.observe(col);
          ro.observe(bar);
          ro.observe(document.documentElement);

          // If your layout toggles classes/styles (e.g., sidebar show/hide, d-none changes)
          const mo = new MutationObserver(() => schedule(alignAndReserve));
          mo.observe(document.body, {
            attributes: true,
            subtree: true,
            childList: true,
          });
          mo.observe(bar, {
            attributes: true,
            attributeFilter: ["class", "style"],
          });

          // Viewport changes & scrolling that might affect left/width
          window.addEventListener("resize", () => schedule(alignAndReserve), {
            passive: true,
          });
          window.addEventListener("scroll", () => schedule(alignAndReserve), {
            passive: true,
          });
          window.addEventListener("load", alignAndReserve);
        })();
      </script>
      <!-- Keyboard hotkeys -->
      <script>
        // Keyboard shortcuts: arrows to navigate, A-D to pick, Space to check/reset, N to focus notes
        (function () {
          const isTypingContext = () => {
            const ae = document.activeElement;
            if (!ae) return false;
            const tag = (ae.tagName || "").toLowerCase();
            if (tag === "input" || tag === "textarea") return true;
            if (ae.isContentEditable) return true;
            return false;
          };

          const isVisible = (el) => {
            if (!el) return false;
            const s = getComputedStyle(el);
            return (
              s.display !== "none" &&
              s.visibility !== "hidden" &&
              el.offsetParent !== null
            );
          };

          const clickIf = (el) => {
            if (el) el.click();
          };

          const pickOption = (opt) => {
            // Only allow picking when in MCQ before evaluation (Check button visible)
            const checkBtn = document.getElementById("check-answer");
            if (!isVisible(checkBtn)) return;
            const btn = document.querySelector(
              `#MCQOptionDiv .mcq-option[data-opt="${opt}"]`
            );
            if (!btn) return;
            // Avoid bypassing lock state
            if (btn.classList.contains("disabled")) return;
            btn.click();
          };

          const focusNotes = () => {
            // Prefer dedicated editor focus if provided by assignment.js
            if (typeof window.focusNotesEditor === "function") {
              try {
                window.focusNotesEditor();
              } catch {}
              const host = document.getElementById("notesInput");
              if (host)
                host.scrollIntoView({ block: "nearest", behavior: "smooth" });
              return;
            }
            // Fallback: treat #notesInput as a standard control/contentEditable
            const notes = document.getElementById("notesInput");
            if (!notes) return;
            const tag = (notes.tagName || "").toLowerCase();
            if (tag === "textarea" || tag === "input") {
              try {
                const len = (notes.value || "").length;
                notes.setSelectionRange(len, len);
              } catch {}
              notes.focus();
            } else if (notes.isContentEditable) {
              try {
                const range = document.createRange();
                range.selectNodeContents(notes);
                range.collapse(false);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
              } catch {}
              notes.focus();
            } else {
              notes.focus();
            }
            notes.scrollIntoView({ block: "nearest", behavior: "smooth" });
          };

          const overlayOpen = () => {
            const el = document.getElementById("image-overlay");
            if (!el) return false;
            const s = getComputedStyle(el);
            return s.display !== "none";
          };

          window.addEventListener("keydown", (e) => {
            if (overlayOpen()) return; // Don't handle shortcuts while image overlay is open
            // Ignore modified shortcuts (Ctrl/Cmd/Alt) to not conflict with system/browser
            if (e.ctrlKey || e.metaKey || e.altKey) return;

            const key = e.key;

            // Navigation with arrows (when not typing)
            if (!isTypingContext()) {
              if (key === "ArrowLeft") {
                e.preventDefault();
                const prev = document.getElementById("nav-prev");
                if (prev && !prev.disabled) clickIf(prev);
                return;
              }
              if (key === "ArrowRight") {
                e.preventDefault();
                const next = document.getElementById("nav-next");
                if (next && !next.disabled) clickIf(next);
                return;
              }
            }

            // Space toggles Check/Reset when not typing
            if (key === " " || key === "Spacebar") {
              if (!isTypingContext()) {
                e.preventDefault();
                const check = document.getElementById("check-answer");
                const reset = document.getElementById("reset-question");
                if (isVisible(check)) clickIf(check);
                else if (isVisible(reset)) clickIf(reset);
              }
              return;
            }

            // Letter shortcuts
            const k = (key || "").toUpperCase();
            if (!isTypingContext()) {
              if (k === "A" || k === "B" || k === "C" || k === "D") {
                pickOption(k);
                return;
              }
              if (k === "N") {
                e.preventDefault();
                focusNotes();
                return;
              }
            }
          });
        })();
      </script>
    </div>
  </body>
</html>
